<% @title = "Список пациентов" %>

<div class="row">
  <div class="col">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0"><i class="bi bi-people"></i> Список пациентов</h4>
        <a href="/patients/new" class="btn btn-main">
          <i class="bi bi-person-plus"></i> Добавить пациента
        </a>
      </div>
      <div class="card-body">
        <!-- Фильтры и поиск -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input type="text" id="search-input" class="form-control" placeholder="Поиск по ФИО, приоритету, дате..." onkeyup="filterPatients()">
              <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                <i class="bi bi-x"></i>
              </button>
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-calendar"></i></span>
              <input type="date" id="date-filter" class="form-control" value="<%= Date.today.strftime('%Y-%m-%d') %>" onchange="filterByDate()">
              <button class="btn btn-outline-secondary" type="button" onclick="clearDateFilter()">
                <i class="bi bi-x"></i>
              </button>
            </div>
          </div>
        </div>

        <div id="patients-table-container">
          <% if @patients.any? %>
            <div class="table-responsive">
              <table class="table" id="patients-table">
                <thead>
                  <tr>
                    <th>ФИО</th>
                    <th>Приоритет</th>
                    <th>Дата рождения</th>
                    <th>Дата поступления</th>
                    <th>Мониторинг</th>
                    <th>Действия</th>
                  </tr>
                </thead>
                <tbody>
                  <% @patients.each do |patient| %>
                    <tr class="patient-row" data-patient-id="<%= patient.id %>" 
                        data-full-name="<%= patient.full_name.downcase %>"
                        data-date-of-birth="<%= patient.date_of_birth %>"
                        data-admission-date="<%= patient.admission_time.to_date.strftime('%Y-%m-%d') %>"
                        data-priority="<%= patient.current_priority %>">
                      <td><strong><%= patient.full_name %></strong></td>
                      <td>
                        <% if patient.latest_assessment %>
                          <span class="priority-badge priority-<%= patient.current_priority %>">
                            <%= patient.current_priority %>
                          </span>
                          <small class="text-muted d-block mt-1">
                            <%= patient.latest_assessment.priority_description %>
                          </small>
                        <% else %>
                          <span class="text-muted">Не оценен</span>
                        <% end %>
                      </td>
                      <td><%= patient.date_of_birth %></td>
                      <td><%= patient.admission_time.strftime("%d.%m.%Y %H:%M") %></td>
                      <td>
                        <div class="form-check form-switch">
                          <input type="checkbox" 
                                 class="form-check-input monitor-checkbox" 
                                 data-patient-id="<%= patient.id %>"
                                 <%= 'checked' if patient.on_monitor %>>
                          <label class="form-check-label">На мониторе</label>
                        </div>
                      </td>
                      <td>
                        <div class="btn-group" role="group">
                          <a href="/patients/<%= patient.id %>" class="btn btn-sm btn-secondary">
                            <i class="bi bi-eye"></i>
                          </a>
                          <a href="/patients/<%= patient.id %>/edit" class="btn btn-sm" style="background-color: #ffa500;">
                            <i class="bi bi-pencil"></i>
                          </a>
                          <form action="/patients/<%= patient.id %>" method="post" style="display: inline;">
                            <input type="hidden" name="_method" value="delete">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Вы уверены?')">
                              <i class="bi bi-trash"></i>
                            </button>
                          </form>
                        </div>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <div class="text-center py-4">
              <i class="bi bi-people" style="font-size: 3rem; color: var(--secondary-color);"></i>
              <p class="mt-3">Пациентов пока нет.</p>
              <a href="/patients/new" class="btn btn-main mt-2">
                <i class="bi bi-person-plus"></i> Добавить первого пациента
              </a>
            </div>
          <% end %>
        </div>

        <!-- Сообщение когда нет результатов -->
        <div id="no-results" class="text-center py-4" style="display: none;">
          <i class="bi bi-search" style="font-size: 3rem; color: var(--secondary-color);"></i>
          <p class="mt-3">Пациенты не найдены.</p>
          <button class="btn btn-main mt-2" onclick="clearFilters()">
            <i class="bi bi-arrow-clockwise"></i> Сбросить фильтры
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.priority-badge {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-weight: bold;
  font-size: 0.875rem;
  color: white;
  text-align: center;
  min-width: 30px;
}

.priority-1 {
  background-color: #dc3545;
  border: 2px solid #c82333;
}

.priority-2 {
  background-color: #fd7e14;
  border: 2px solid #e65c00;
}

.priority-3 {
  background-color: #ffc107;
  border: 2px solid #e6a800;
  color: #212529 !important;
}

.priority-4 {
  background-color: #28a745;
  border: 2px solid #218838;
}

.priority-5 {
  background-color: #17a2b8;
  border: 2px solid #138496;
}

/* Анимация для приоритетных пациентов */
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.priority-1, .priority-2 {
  animation: pulse 2s infinite;
}

/* Стили для таблицы */
.table th {
  background-color: #f8f9fa;
  border-top: none;
  font-weight: 600;
  color: #495057;
}

.table td {
  vertical-align: middle;
}

/* Стили для фильтров */
.input-group-text {
  background-color: #f8f9fa;
  border-color: #dee2e6;
}

#search-input:focus,
#date-filter:focus {
  border-color: var(--main-color);
  box-shadow: 0 0 0 0.2rem rgba(84, 198, 84, 0.25);
}

/* Анимация для строк таблицы */
.patient-row {
  transition: all 0.3s ease;
}

.patient-row.hidden {
  display: none;
}

/* Улучшение отображения на мобильных устройствах */
@media (max-width: 768px) {
  .priority-badge {
    font-size: 0.75rem;
    padding: 0.2rem 0.5rem;
  }
  
  .text-muted {
    font-size: 0.7rem;
  }
  
  .input-group {
    margin-bottom: 1rem;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Инициализация переключателей мониторинга
  const checkboxes = document.querySelectorAll('.monitor-checkbox');
  
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const patientId = this.dataset.patientId;
      const isChecked = this.checked;
      
      fetch(`/patients/${patientId}/toggle_monitor`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ on_monitor: isChecked })
      })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (!data.success) {
          this.checked = !isChecked;
          alert('Ошибка при обновлении: ' + (data.errors || data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        this.checked = !isChecked;
        alert('Произошла ошибка при обновлении: ' + error.message);
      });
    });
  });

  // Применяем фильтр по текущей дате при загрузке
  filterByDate();
});

// Функция фильтрации пациентов
function filterPatients() {
  const searchText = document.getElementById('search-input').value.toLowerCase();
  const dateFilter = document.getElementById('date-filter').value;
  const rows = document.querySelectorAll('.patient-row');
  let visibleCount = 0;

  rows.forEach(row => {
    const fullName = row.getAttribute('data-full-name');
    const dateOfBirth = row.getAttribute('data-date-of-birth');
    const admissionDate = row.getAttribute('data-admission-date');
    const priority = row.getAttribute('data-priority');
    
    const matchesSearch = searchText === '' || 
                         fullName.includes(searchText) ||
                         dateOfBirth.includes(searchText) ||
                         priority.includes(searchText);
    
    const matchesDate = dateFilter === '' || admissionDate === dateFilter;
    
    if (matchesSearch && matchesDate) {
      row.classList.remove('hidden');
      visibleCount++;
    } else {
      row.classList.add('hidden');
    }
  });

  updateNoResultsMessage(visibleCount);
}

// Функция фильтрации по дате
function filterByDate() {
  const dateFilter = document.getElementById('date-filter').value;
  const searchText = document.getElementById('search-input').value.toLowerCase();
  const rows = document.querySelectorAll('.patient-row');
  let visibleCount = 0;

  rows.forEach(row => {
    const fullName = row.getAttribute('data-full-name');
    const admissionDate = row.getAttribute('data-admission-date');
    const priority = row.getAttribute('data-priority');
    
    const matchesSearch = searchText === '' || 
                         fullName.includes(searchText) ||
                         priority.includes(searchText);
    
    const matchesDate = dateFilter === '' || admissionDate === dateFilter;
    
    if (matchesSearch && matchesDate) {
      row.classList.remove('hidden');
      visibleCount++;
    } else {
      row.classList.add('hidden');
    }
  });

  updateNoResultsMessage(visibleCount);
}

// Функция обновления сообщения "нет результатов"
function updateNoResultsMessage(visibleCount) {
  const noResults = document.getElementById('no-results');
  const tableContainer = document.getElementById('patients-table-container');
  
  if (visibleCount === 0) {
    noResults.style.display = 'block';
    tableContainer.style.display = 'none';
  } else {
    noResults.style.display = 'none';
    tableContainer.style.display = 'block';
  }
}

// Функция очистки поиска
function clearSearch() {
  document.getElementById('search-input').value = '';
  filterPatients();
}

// Функция очистки фильтра даты
function clearDateFilter() {
  document.getElementById('date-filter').value = '';
  filterByDate();
}

// Функция сброса всех фильтров
function clearFilters() {
  document.getElementById('search-input').value = '';
  document.getElementById('date-filter').value = '<%= Date.today.strftime('%Y-%m-%d') %>';
  filterPatients();
}

// Обработчики событий для мгновенного поиска
document.getElementById('search-input').addEventListener('input', filterPatients);
document.getElementById('date-filter').addEventListener('change', filterByDate);

// Добавляем поддержку клавиши Escape для очистки поиска
document.getElementById('search-input').addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    clearSearch();
  }
});
</script>