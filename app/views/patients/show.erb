<div class="row">
  <div class="col-6">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞—Ü–∏–µ–Ω—Ç–µ</h2>
      </div>
      <div class="card-body">
        <p><strong>–§–ò–û:</strong> <%= @patient.full_name %></p>
        <p><strong>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong> <%= @patient.date_of_birth %></p>
        <p><strong>–î–∞—Ç–∞ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è:</strong> <%= @patient.admission_time.strftime("%d.%m.%Y %H:%M") %></p>

        <% if @patient.assessments.any? %>
          <% latest_assessment = @patient.assessments.last %>
          <div class="card mt-3">
            <div class="card-header">
              <h3>üìà –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞</h3>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-6">
                  <p><strong>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</strong> 
                    <span class="priority-badge priority-<%= latest_assessment.calculate_priority %>">
                      <%= latest_assessment.calculate_priority %> - <%= latest_assessment.priority_description %>
                    </span>
                  </p>
                  <p><strong>–î–∞—Ç–∞ –æ—Ü–µ–Ω–∫–∏:</strong> <%= (latest_assessment.created_at + 7*3600).strftime("%d.%m.%Y %H:%M") %></p>
                </div>
                <div class="col-6">
                  <p><strong>–ß–°–° –º–∞—Ç–µ—Ä–∏:</strong> <%= latest_assessment.heart_rate_mother || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ' %></p>
                  <p><strong>–ê–î:</strong> <%= latest_assessment.blood_pressure || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ' %></p>
                </div>
              </div>
            </div>
          </div>
        <% end %>
        
        <div class="form-group">
          <label class="form-check">
            <input type="checkbox" 
                   name="on_monitor" 
                   value="true" 
                   <%= @patient.on_monitor ? 'checked' : '' %>
                   onchange="toggleMonitor(this, <%= @patient.id %>)">
            –û—Ç–æ–±—Ä–∞–∂–∞—Ç—å –Ω–∞ –º–æ–Ω–∏—Ç–æ—Ä–µ
          </label>
        </div>

        <script>
        function toggleMonitor(checkbox, patientId) {
          console.log('Toggling monitor for patient:', patientId, 'Status:', checkbox.checked);
          
          fetch(`/patients/${patientId}/toggle_monitor`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({ 
              on_monitor: checkbox.checked
            })
          })
          .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('Response data:', data);
            if (!data.success) {
              checkbox.checked = !checkbox.checked;
              alert('–û—à–∏–±–∫–∞: ' + (data.errors || data.error || 'Unknown error'));
            } else {
              alert('–°—Ç–∞—Ç—É—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω: ' + (data.on_monitor ? '–í–ö–õ' : '–í–´–ö–õ'));
            }
          })
          .catch(error => {
            console.error('Error:', error);
            checkbox.checked = !checkbox.checked;
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
          });
        }
        </script>
        
        <div class="row">
          <div class="col">
            <a href="/patients/<%= @patient.id %>/edit" class="btn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
            <a href="/assessments/new?patient_id=<%= @patient.id %>" class="btn">–î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</a>
            <a href="/patients" class="btn btn-secondary">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
          </div>
        </div>
      </div>
    </div>
  </div>
  
 
</div>